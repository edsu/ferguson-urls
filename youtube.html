<html>

  <head>
  <title>14,177 Ferguson YouTube Videos</title>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
  <style>
    body {
      text-align: center;
    }
    header {
      margin: 15px;
    }
    footer {
      margin: 15px;
    }
  </style>
</head>

<body>

  <a href="http://github.com/edsu/ferguson-urls"><img style="position: absolute; top: 0; right: 0; border: 0; z-index: 3;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"></a>

  <section class="container">
    <header class="row">
      <h3>14,177 (Random) Ferguson YouTube Videos</h3>
    </header>
    <div class="row">
      <div id="video"></div>
    </div>
    <footer>
    These YouTube videos were posted to Twitter with the ferguson hashtag.
    Click to go to the next one, or wait for it to advance when it ends.
    </footer>
  </section>

  <script src="youtube.js"></script>
  <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
  <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
  <script>

    // youtube loading silliness 
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    var player;
    function onYouTubeIframeAPIReady() {
      player = new YT.Player('video', {
        height: '620',
        width: '800',
        events: {
          'onReady': onPlayerReady,
          'onError': onError,
          'onStateChange': onPlayerStateChange
        }
      });

    }

    function onPlayerReady(event) {
      playRandomVideo();
    }

    function onPlayerStateChange(event) {
      if (event.data == YT.PlayerState.PAUSED || event.data == YT.PlayerState.ENDED) {
        playRandomVideo();
      }
    }

    function playRandomVideo() {
      var videoId = getVideoId();
      player.loadVideoById(videoId);
      player.playVideo();
    }

    function onError(event) {
      playRandomVideo();
    }

    var idsSeen = {};
    function getVideoId() {
      while (true) {
        var v = youtube[Math.floor(Math.random() * youtube.length)];
        var match = v.url.match(/youtube.com\/v\/(.{11})/);
        if (! match) {
          match = v.url.match(/youtube.com\/watch\?v=(.{11})/);
        }
        if (match && ! idsSeen[match[1]]) {
          idsSeen[match[1]] = true;
          return match[1];
        }
      }
    }

  </script>
</body>

</html>
